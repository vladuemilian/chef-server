#! /usr/bin/env ruby
#
# Author:: Tyler Cloke <tyler@chef.io>
# Copyright:: Copyright (c) 2014 Chef, Inc.
# License:: Apache License, Version 2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# Usage:
# ./bootstrap-platform CONFIG_FILE USER_CONFIG_FILE

require 'rubygems'
require 'bundler/setup'
require 'restclient'
require 'json'
require 'yaml'
require 'uuid'
require 'sequel'

class BootstrapPlatform

  PLACEHOLDER_GLOBAL_ORG_ID = "00000000000000000000000000000000"

  def initialize(config_file, user_config_file)
    @config_file, @user_config_file = config_file, user_config_file
  end

  def bootstrap
    config = YAML.load_file(@config_file)

    db = Sequel.connect("#{config['db_driver']}://#{config['db_user']}:#{config['db_password']}@#{config['db_host']}/opscode_chef")

    #########################
    # create  authz objects #
    #########################

    # for superuser
    superuser_authz_id = create_object_in_authz("actors", config['bifrost_superuser_id'], config['bifrost_host'], config['bifrost_port'])

    # for global-admins global group
    global_admins_authz_id = create_object_in_authz("groups", config['bifrost_superuser_id'], config['bifrost_host'], config['bifrost_port'])

    ####################
    # create superuser #
    ####################

    # load certificate
    user = YAML.load_file(@user_config_file)
    user['public_key'] = File.read(config['superuser_public_key'])

    # create serialized_object
    serialized_object = {}
    ["first_name", "last_name", "display_name"].each do |field|
      serialized_object[field] = user[field]
      # these aren't database columns, so remove from user object
      user.delete(field)
    end
    user['serialized_object'] = JSON.generate(serialized_object)

    # generate / assign IDs
    user['authz_id'] = superuser_authz_id
    user['id'] = UUID.new.generate(:compact)

    # create timestamps
    user_created_time = Time.now.utc
    user['created_at'] = user_created_time
    user['updated_at'] = user_created_time
    user['last_updated_by'] = config['bifrost_superuser_id']

    # indicates public_key instead of cert
    user['pubkey_version'] = 0

    # not an admin (strangely)
    user['admin'] = 'f'

    # insert populated user object into the postgres
    db[:users].insert(user)

    ##############################
    # create superuser container #
    ##############################
    global_container_authz_ids = create_global_containers(superuser_authz_id, PLACEHOLDER_GLOBAL_ORG_ID, db, config['bifrost_host'], config['bifrost_port'])

    #####################################
    # create global-admins global group #
    #####################################
    create_global_admins_global_group(db, superuser_authz_id, PLACEHOLDER_GLOBAL_ORG_ID, global_admins_authz_id)
    # grant this object create and read on the users container
    grant_authz_object_create_read("containers", global_container_authz_ids['users'], global_admins_authz_id, superuser_authz_id, config['bifrost_host'], config['bifrost_port'])
  end

  private

  def create_object_in_authz(object_name, requester_id, bifrost_host, bifrost_port)
    url = "http://#{bifrost_host}:#{bifrost_port}/#{object_name}"
    headers = {
      :content_type => :json,
      :accept => :json,
      'X-Ops-Requesting-Actor-Id' => requester_id
    }

    result = RestClient.post(url, "{}", headers)
    JSON.parse(result)["id"]
  end

  def grant_authz_object_create_read(granted_on_object_type, granted_on_id, granted_to_id, requester_id, bifrost_host, bifrost_port)
    base_url = "http://#{bifrost_host}:#{bifrost_port}/#{granted_on_object_type}/#{granted_on_id}/acl"
    headers = {
      :content_type => :json,
      :accept => :json,
      'X-Ops-Requesting-Actor-Id' => requester_id
    }

    # grant create perm
    create_url = "#{base_url}/create"
    original_create = JSON.parse(RestClient.get(create_url, headers))
    original_create["groups"] << granted_to_id
    RestClient.put(create_url, original_create.to_json, headers)

    # grant read perm
    read_url = "#{base_url}/read"
    original_read = JSON.parse(RestClient.get(read_url, headers))
    original_read["groups"] << granted_to_id
    RestClient.put(read_url, original_read.to_json, headers)
  end

  def create_global_containers(superuser_authz_id, placeholder_id, db, bifrost_host, bifrost_port)
    global_container_authz_ids = {}
    %w(organizations users).each do |name|
      authz_id = create_object_in_authz("containers", superuser_authz_id, bifrost_host, bifrost_port)
      global_container_authz_ids[name] = authz_id
      created_time = Time.now.utc
      db[:containers].insert(:name => name, :id => authz_id, :org_id => placeholder_id, :last_updated_by => superuser_authz_id, :authz_id => authz_id, :created_at => created_time.to_s[0..18], :updated_at => created_time.to_s[0..18])
    end
    global_container_authz_ids
  end

  def create_global_admins_global_group(db, superuser_authz_id, placeholder_id, precreated_authz_id)
    created_time = Time.now.utc.to_s[0..18]

    global_admins = {}
    global_admins['id'] = UUID.new.generate(:compact)
    global_admins['org_id'] = placeholder_id
    global_admins['authz_id'] = precreated_authz_id
    global_admins['name'] = 'global-admins'
    global_admins['last_updated_by'] = superuser_authz_id
    global_admins['created_at'] = created_time
    global_admins['updated_at'] = created_time
    db[:groups].insert(global_admins)
  end
    
end

if __FILE__ == $0
  if ARGV.length != 2
    puts "You must pass two arguments. Usage:"
    puts "./bootstrap-platform CONFIG_FILE USER_CONFIG_FILE"
    exit 1
  end
  BootstrapPlatform.new(ARGV[0], ARGV[1]).bootstrap
end
